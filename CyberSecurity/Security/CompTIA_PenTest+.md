# CompTIA PenTest+

## Penetration Testing Methodology and Frameworks

The pentest methodology varies depending on the type of client and the target of the test.  
However, it usually covers the following stages :
- **Information gathering** : passive collection of publicly accessible information (OSINT and research, no scan)
- **Enumeration / Scanning** : active discovery of the target applications and services (port scan, vulnerability scan...)
- **Exploitation** : leveraging discovered vulnerabilities to gain access (public or custom exploits)
- **Privilege escalation** : expand access to the target system (pivoting or gaining higher privileges)
- **Post-exploitation** : find what information are exposed after exploitation, cover tracks, report findings

Some frameworks provide guidelines for the penetration testing of some systems :


- **PTES** (Penetration Testing Execution Standard)  
  PTES is a framework to conduct thorough and effective penetration tests by defining 7 sections of a pentest :
  - **Pre-engagement interactions** : first communication and reasons to conduct the pentest
    - signing agreements
    - defining scope and timelines
    - lines of communication and emergency contacts
    - defining acceptable methods...
  - **Information gathering** : gathering information about the target
    - open-source intelligence
    - footprinting
  - **Threat modeling** : identify assets and processes that need protection, the threats and the capabilities
  - **Vulnerability analysis** : passive and active testing to identify vulnerabilities
  - **Exploitation** : actively exploiting the discovered vulnerabilities
  - **Post-exploitation** : accessing sensitive data, privilege escalation, backdoors installation...
  - **Reporting** : detailed report of all conducted activities, vulnerabilities, system accessed and potential impact  
  http://www.pentest-standard.org/index.php/Main_Page


- **CDPT Guidelines** (CREST Defensible Penetration Test)  
  CREST (Council of Registered Security Testers) is an organization of security companies setting rigorous standards for cybersecurity services.  
  Companies go through an extended audit and accreditation process to get CREST certified.  
  The CDPT guidelines are split into 10 sections.  
  https://www.crest-approved.org/wp-content/uploads/2022/12/CREST-Defensible-Penetration-Test-v5-2.pdf
  

- **OSSTMM** (Open Source Security Testing Methodology Manual) developed by ISECOM  
  Detailed framework of testing strategies for systems, software, applications, communication and human aspect.  
  It includes testing of telecommunications, and wired and wireless networks (128 pages).  
  It was not updated since 2010, but is still a relevant reference.  
  https://www.isecom.org/OSSTMM.3.pdf


- **OWASP Framework** (Open Web Application Security Project)  
  Community-driven framework to test the security of web applications and services.  
  It includes the OWASP Top 10 ranking of the most frequent vulnerabilities in websites and their remediation.  
  https://owasp.org/www-project-web-security-testing-guide/stable/


- **OWASP MASVS** (OWASP - Mobile Application Security Verification Standard)  
  MASVS sets baseline security standards to protect mobile applications.  
  It defines multiple control groups to divide the attack surface of mobile applications :  
    - MASVS-STORAGE : security of the sensitive data storage
    - MASVS-CRYPTO : centered on cryptographic measures
    - MASVS-AUTH : enforce strong mechanisms to verify identity and grant access rights
    - MASVS-NETWORK : security of network communication between the app and remote endpoints
    - MASVS-PLATFORM : interaction with the underlying mobile platform and other apps on the device
    - MASVS-CODE : secure development and maintenance of the app's code
    - MASVS-RESILIENCE : ability to resist reverse engineering and tampering attempts
    - MASVS-PRIVACY : enforce the implementation of privacy controls in compliance with privacy laws and regulations  
  https://github.com/OWASP/owasp-masvs


- **NIST CSF** (National Institute of Standards and Technology - Cybersecurity Framework)  
  Popular framework (50% of US organizations) used to improve an organization's cybersecurity standards and manage the risk of cyber-threats.  
  It provides guidelines on security controls and benchmarks.  
  https://www.nist.gov/cyberframework  
  The NIST also offers some special publications :  
  - **SP 800-171** : Protected Controlled Unclassified Information in Non-Federal Systems and Organizations
  - **SP 800-53** : Security and Privacy Controls for Information Systems and Organizations (500 pages, list controls that should be in place)


- **NCSC CAF** (National Cyber Security Centre - Cyber Assessment Framework)  
  Extensive framework of 14 principles to assess the risk of cyber threat and how to defend against these threats.  
  https://www.ncsc.gov.uk/collection/cyber-assessment-framework/caf-objective-a-managing-security-risk


- **MITRE ATT&CK** (Adversary Tactics, Techniques & Common Knowledge)  
  Detailed playbook of different ways attackers can attack a system.  
  Developed to improve the understanding of threat behaviors and defend against them.  
  It is a catalog of tactics (initial access, execution, persistence, privilege escalation, defense evasion...).  
  Each tactic is further divided into specific techniques, for example initial access can be achieved by spear phishing, drive-by compromise...  
  https://attack.mitre.org


- **ISSAF** (Information Systems Security Assessment Framework)  
  Open-source resource providing a comprehensive security assessment framework (1264 pages).  
  It stopped receiving updated in 2006, so it is deprecated and not in the PenTest+ objective from version PT0-003.  
  Other penetration testing frameworks like OSSTMM, OWASP or PTES should be used instead.


- **STRIDE** : security model developed by Microsoft for software development and cybersecurity
  - **Spoofing** : assume the identity of another user to gain unauthorized access to data or systems
  - **Tampering** : malicious alteration of data
  - **Repudiation** : actions that cannot be traced back to an individual user
  - **Information Disclosure** : unauthorized access to confidential information 
  - **Denial of Service** : overwhelm the system to disrupt normal activity for legitimate users
  - **Elevation of Privilege** : limited user gaining higher permission over the system


- **Purdue Model for ICS (Industrial Control System)** : framework to protect OT environments (Operational Technology)
  - define network segmentation to isolate and protect OT systems from cyber threats
  - defines 7 zones :
    - Level 5 - External / Vendor Support / Cloud Access
    - Level 4 - Business Logistics Systems / Enterprise IT Level
    - Level 3.5 - Demilitarized Zone (control exchange of data between IT and OT systems with firewalls and proxies)
    - Level 3 - Manufacturing Operations System Zone
    - Level 2 - Control System Zone (include SCADA systems to control physical processes)
    - Level 1 - Intelligent Devices Zone (include PLCs)
    - Level 0 - Physical Process Zone (include sensors)


- **OCTAVE** (Operationnally Critical Threat, Asset and Vulnerability Evaluation)  
  - framework designed to manage organizational risks
  - beneficial for small to medium-size organizations without large dedicated security teams
  - encourage organizations to take ownership of the security strategies instead of relying on external consultants
  - emphasize protecting critical assets based on their value to the organization
  - include 3 phases split into 8 processes


- **DREAD** : Risk assessment model to quantify and prioritize the level of risk from several security threats  
  Each threat is assigned a score between 0 and 10 for each of the 5 DREAD categories.  
  The total threat score defines its severity : Low (0-10) / Medium (11-24) / High (25-39) / Critical (40-50)
    - **Damage Potential** : how much damage can a successful exploitation cause ?
    - **Reproducibility** : how easily the threat can be replicated by an attacker ?
    - **Exploitability** : how much effort is required to exploit the vulnerability ?
    - **Affected Users** : what users are impacted in a successful exploitation ?
    - **Discoverability** : how easy can the vulnerability be discovered by an attacker ?


### Regulations

Some companies request a penetration test as part of the compliance to some regulations.  
The penetration test must focus on these regulations' requirements to test the company's compliance.  

- **GDPR** (General Data Protection Regulation)  
GDPR imposes strict rules on data processing and storage within the EU and for business dealing with EU citizens' data.  
It requires explicit permission for data processing, and it requires a data protection officer in the company.  


- **GLBA** (Gramm-Leach-Bliley Act)  
GLBA protects the privacy of individuals' financial information held by financial institutions.


- **HIPAA** (Health Insurance Portability and Accountability Act)  
HIPAA regulates the confidentiality and security of healthcare information in the US.  
It requires patient data encryption, the implementation of secure access control and regular audits.  


- **PCI-DSS** (Payment Card Industry - Data Security Standard)  
PCI-DSS is not a regulation, but a standard agreed upon by the major actors of the payment card industry.  
It requires a secure network, strong access controls and regular network monitoring ad testing.


- **ISO/IEC 27000 Series**  
These standards are not legally mandatory, but they are highly recommended for organization handling sensitive data.  
They provide specifications for implementing, maintaining and improving information security management systems (ISMS).  
Many organizations want ISO/IEC 27000 certification to demonstrate strong security practices.  
Many vendors also want this certification as it is a main selection criteria for their customers.  
 

## Pre-engagement Activities

These are the tasks that need to be completed before the beginning of a penetration test. 

### Type of assessment
- **network** : evaluate the security of the entire network, both hardware and software (routers, switches, firewalls...)
  - network topology
  - firewall configuration
  - security policies
- **wireless** : focus on security assessment of wireless networks
- **application** : target a specific application, either developed in-house of by a 3rd party (code, dependencies, configuration)
  - usually performed before the application deployment
  - check compliance with relevant security standards
- **mobile** : focused on mobile applications and platform
  - data leakage
  - improper session handling
  - insecure data storage
- **web** : securing a web application (SQLi, XSS, security misconfiguration...)
- **cloud** : security posture of cloud-based services and infrastructure (AWS, Azure, GCP)
- **API** : test APIs used for the integration between systems and services


### Legal Agreements

- **NDA** (Non-Disclosure Agreements) : legally binding contract establishing a confidential relationship between the involved parties

- **MSA** (Master Service Agreement) : foundational terms of the business relationship between the service provider and the client
  - project scope
  - payment details
  - confidentiality clauses
  - liability issues

- **SoW** (Statement of Work) : specifics of the project or service provided (objectives, deliverables, scope, timelines, payment schedules...)

- **ToS** (Terms of Service) : govern the use of the service provided by the PenTest firm 
  - specify tools to use
  - specify limitations (no reverse-engineering...)

- **SLA** (Service Level Agreement) : commitment from the service provider for a specific quality of service (availability, responsibilities, permitted pentests...)


### Legal and Ethical Considerations

- **Authorization letters** : formally granting permission to the penetration testing team to conduct simulated cyber-attacks against the system
  - detailed scope (networks, hosts, applications), validity period, allowed techniques
  - testing on cloud provider infrastructure requires to contact the cloud vendor, for ex AWS has a specific policy for penetration testing

- **Mandatory reporting** : dictate how and when findings must be disclosed

- **Escalation path** : clearly estabish the chain of command and communication protocols in case of issue (unstable system, prod system impacted, breach of data...)

- **Export Restriction** : some technologies are not allowed to be exported outside of the US, mostly around encryption

- **National and local restriction** : some countries have specific regulations and customs that must be followed

- **Corporate Policies** : specific rules for the client organization


### Rules of Engagement

Rules of Engagement are guidelines to ensure the testing team and the client are in line with the way the tests are conducted.
- **Exclusions** : areas in the pentest that are off-limits , due to data sensitivity, business disruption or other constraints
- **Test Cases** : types of tests that will be conducted, like SQLi, password cracking, ...
- **Testing Window**
- **Goal Reprioritization** : change in test's priorities as the pentest progresses and vulnerabilities are found


### Shared Responsibility Model

The shared responsibility model defines the role of each party in maintaining the security of the system :
- **hosting providers** : secure the infrastructure that runs the service offered to customers
- **customer** : secure the data and applications running on the infrastructure  
- **penetration testers** : sort of external auditors, finding vulnerabilities that threat actors could exploit
- **3rd party application vendor** : secure the data within the 3rd party application


## Information Gathering

### Passive Reconnaissance

Gathering information about the target from public sources to minimize the risk to get detected:
- target's official website
- HTML scraping (BeautifulSoup in Python)
- DNS records (dig / nslookup)
- open-source repos (GitHub, BitBucket, SourceForge)
- check images and archive websites (The Wayback Machine)


### OSINT (Open-Source Intelligence)

Publicly available information used to gather insight about the target :
- who works there ?
- what is the company structure ?
- who can share sensitive information ?

The main sources of OSINT are :

- **social media**
  - Facebook for company activities
  - Instagram for physical security and employees interaction
  - LinkedIn for technologies in use and new hires (potentially more vulnerable)
  - Twitter (X) for current activity in the company due its real-time aspect

- **job boards** (LinkedIn or Indeed)

- **information disclosure**
  - error messages revealing database dump or internal details
  - cloud access permission misconfiguration

- **CT logs** (Certificate Transparency) can reveal some subdomains

- **Google Hacking** (advanced Google search optimization)
  - `site:example.com` : limit to a specific domain
  - `intitle:"report"` : limit to pages with a specific string in the title
  - `inurl:login` : limit to pages with a specific keyword in the URL 
  - `filetype:pdf` : limit the pages to a given file type


### Network Sniffing

Network Sniffing refers to the capture of data packets as they travel across the network.  
It allows **network reconnaissance**, which is the gathering of information about the topology and architecture of the network.  
It reveals the active hosts, services and key communication endpoints.  

Network traffic is captured in a PCAP file by network sniffers (WireShark or tcpdump).  
IoT and OT protocols (like MQTT and Modbus) can also be captured in WireShark (Modbus requires a specific WireShark plugin).


## Enumeration and Scanning


### Active Reconnaissance

- **Port scanning** to identify open/closed TCP/UDP ports and the services they run (nmap)
- **Banner Grabbing** to learn about running software's type and version (wget, curl, telnet, netcat, nmap...)


### Enumeration

Use the knowledge gained from information gathering, and actively dig deeper to list the target's resources.  
During enumeration, we try to get a list of services, devices, networks, users, domains, protocols...  
It gives a good picture of the target's landscape and helps identify the potential entry points.

- Ping scan to know which machines are online (nmap)
- TCP scan to discover open ports on a machine (nmap)
- OS footprinting to detect the OS on the target host (nmap)
- Windows host enumeration
  - `net view` : list machines on the network
  - `arp -a` : display the local ARP cache
  - `ipconfig /displaydns` : display the local DNS cache
- Active Directory enumeration
  - `Get-ADDomain` : information about the AD domain the machine is connected to
  - `Get-ADComputer -Filter *` : information about computers in the AD environment
  - `Get-ADGroupMember` : information about members of an AD group
- User enumeration
  - `Get-LocalUser` : information about all local user accounts
  - `net user` : information about each user
  - `getuid` Meterpreter command showing the access level of the current user
  - `/etc/passwd` : list users in Linux
  - `/etc/shadow` : list user passwords in Linux
- Emails enumeration (used for social engineering)
  - query SMTP servers with `VRFY` and `EXPN` to verify existence of an email address or list mailing list members
  - search engines and online databases like **the Harvester**
  - use social media
  - whois lookup to reveal admin emails
- Permission enumeration : identify access controls within a system
  - rights assigned to users and groups on files, directories, databases, network shares...
  - `PowerView` is a PowerShell tool used for network enumeration and privilege escalation
  - `sqlmap` can enumerate database users on an application vulnerable to SQLi
  - `SMBMap` and `CrackMapExec` can be used to enumerate network shares and their permissions
  - AWS CLI and Azure PowerShell are used to enumerate cloud permissions
- Wireless devices enumeration
  - war-driving : looking for unsecure wireless access points with a laptop, smartphone or other wireless-enabled device
  - tools to detect wireless access points : `aircrack-ng`, `kismet`, `wifite`
  - `wigle.net` offers a map of the world with wifi networks (but the free version has a very low daily limit)
- Secrets enumeration (cloud access keys, API keys, passwords, session tokens...)
  - public source code repositories (GitHub, BitBucket...) 
  - `Pacu` : an open-source AWS exploitation framework designed to assess the security of AWS accounts
    - search through environment variables, configuration files, metadata services...
    - list user accounts
    - obtain cloud access keys
    - gain control of virtual machines
- Web enumeration
  - web crawling : automated browsing of the web to gather information (dirbuster, gobuster)
  - manual enumeration
    - `robots.txt` file telling web crawlers which parts of websites should not be accessed (can reveal hidden areas)
    - a sitemap is an XML file listing all the URLs of the website, intended to help search engines index the site
    - Web application firewalls (WAF) can reveal info on the internal machines if not configured properly 


### Scanning

Many vulnerability scanners can be used to identify potential vulnerabilities in the target system :

- **Network / Host Scanners**
  - Nessus
  - OpenVAS
  - Qualys


- **Web Application Scanners**
  - Burp Suite
  - IBM Security AppScan
  - Acunetix
  - OWASP ZAP
  - Nikto
  - SkipFish
  - Wapiti

These scanners generate a long list of potential vulnerability in the configuration.  
Some of them assign a severity to each identified potential vulnerability.  
An important part of the result analysis is to prioritize these vulnerabilities.  

All vulnerabilities found by automated scans need to be verified, to discard false positives.  
For example SQLi vulnerabilities can be manually confirmed, or identified subdomains can be checked with a manual DNS query.  

Target assets must be prioritized to identify high value assets (systems, data, processes...).  

A scan can be authenticated or non-authenticated, by providing or not some valid access credentials.  
An **authenticated scan** can identify more vulnerabilities, that an attacker could exploit if he manages to get credentials.  


#### Types of vulnerabilities

- EOL Software : no patches will ever be created so they most likely contain unpatched known vulnerabilities (Windows XP, Adobe Flash Player...)
- Outdated programs or libraries : may contain known vulnerabilities
- Default Credentials : many network devices or applications ship with default credentials and are left unchanged
- Unneeded services running
- Vulnerable encryption : outdated algorithm (MD5, SHA1...) or version (SSL/TLS)
- Exposed configuration files or APIs


#### Application scanning

Software and Web applications are one of the main targets in a penetration test.  

**DAST** (Dynamic Application Security Testing) is the testing of an application outside-in while it is running.  
It does not require access to the source code and identifies real-world vulnerabilities that an attacker could exploit.  
Common DAST tools include OWASP ZAP and the Burp Suite.  

**IAST** (Interactive Application Security Testing) is the testing of the application from the inside while it is running.  
It is a combination of dynamic and static testing, as the IAST tool has access to the source code but works on the running application.  
It can identify which parts of the code cause specific issues, and provide real-time feedback to the developers.  
Common IAST tools include Contract Security and CheckMarx IAST.  

**SAST** (Static Application Security Testing) is the testing of the application source code and binary without executing the application.  
It can identify vulnerabilities before the application deployment, improve the code quality and integrate with CI/CD tools.  
Common SAST tools include SonarQube, CheckMarx and Veracode.  

**SCA** (Software Composition Analysis) is a method used to identify and manage open-source components used by an application.  
It checks for known vulnerabilities, outdated components and license compliance issues.  
SCA does not analyze the custom code making use of these open-source components.

**Trivy** is a CLI tool that can be used to scan container images of Kubernetes clusters.


#### Wireless scanning

- aircrack-ng
- InSSIDer
- Wigle.net
- Reaver


#### Packet Crafting

Packet crafting is used to send custom packets to the target and observe the response to identify vulnerabilities.
- Scapy
- Impacket 
- Hping


## Reporting

- Create a clear executive summary with business impact (understandable by non-tech management people)
- Detail the scope and methodology
- Present findings and evidence
- Prioritize vulnerabilities (critical / high / medium / low)
- Provide actionable recommendations
- Assess the overall security posture
- Include any limitation (off-limit hours / machines / methods...)

### Documenting the attacks

- attack path : detailed record of all the steps taken to exploit vulnerabilities and achieve objectives
- low-level diagram : represents the technical details of the attack, showing the network layout, the exploited vulnerabilities and the taken actions 
- storyboard : high-level visual representation of the attack (like a comic strip)


## Reference Documentation

- **CERT** (Computer Emergency Response Team)  
  Website maintained by the US federal government listing all known vulnerabilities identified, publicly or added by security partners.  
  http://cisa.gov/uscert


- **JPCERT** (Japanese CERT)  
  List alerts and advisories about viruses and security issues on the rise.  
  https://www.jpcert.or.jp/


- **NVD** (National Vulnerability Database)  
  Provided by the NIST (National Institute of Standards and Technology)  
  It associates a CVSS score to each CVE.  
  https://nvd.nist.gov/


- **CAPEC** (Common Attack Pattern Enumeration and Classification)  
  Resource to understand common attack patterns, that attackers use and penetration testers can be asked to emulate.  
  https://capec.mitre.org/

